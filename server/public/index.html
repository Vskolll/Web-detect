<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Проверка устройства 18+</title>

<script>
  window.__API_BASE = location.origin.replace(/\/+$/, "");
</script>

<style>
/* ------ ФОН ВИДЕО ------ */
body, html {
  padding: 0;
  margin: 0;
  height: 100%;
  width: 100%;
  overflow: hidden;
  font-family: system-ui, sans-serif;
}

.video-bg {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  z-index: -1;
}

/* затемняем фон, если нужно — можно убрать */
.video-overlay {
  position: fixed;
  top:0;left:0;
  width:100%;height:100%;
  background: rgba(0,0,0,0.35);
  z-index:-1;
}

/* ------ КАРТОЧКА ------ */
.card {
  position: relative;
  width: 90%;
  max-width: 420px;
  padding: 24px;
  margin: 0 auto;
  margin-top: 40px;

  background: rgba(255, 255, 255, 0.88);
  backdrop-filter: blur(8px);

  border-radius: 16px;
  box-shadow: 0 0 20px rgba(0,0,0,0.2);

  text-align: center;
}

button {
  width: 100%;
  padding: 14px;
  margin-top: 12px;
  font-size: 16px;
  font-weight: 600;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  background: #000;
  color: #fff;
}

#enterBtn {
  display: none;
}

#fpId {
  display: none;
  font-size: 12px;
  margin-top: 6px;
}

.reason {
  font-size: 13px;
  margin-top: 4px;
}

</style>

</head>
<body>

<!-- === ВИДЕО-ФОН === -->
<video class="video-bg" autoplay muted loop playsinline>
  <source src="/21121.mp4" type="video/mp4">
</video>
<div class="video-overlay"></div>

<!-- === КАРТОЧКА === -->
<div class="card">

  <h2 id="title">Проверка устройства</h2>
  <p id="text">Ожидание начала проверки…</p>
  <div class="reason" id="reason"></div>

  <div id="fpId">
    ID устройства: <code></code>
  </div>

  <button id="installerCheckBtn">Проверить инсталлеры</button>

  <button id="startFlowBtn">Начать проверку устройства</button>

  <button id="enterBtn">Войти 18+</button>

  <p id="note" style="font-size:12px;color:#222;margin-top:12px;"></p>

</div>

<!-- Проверка инсталлеров -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("installerCheckBtn");
  const schemes = [
    "itms-beta://",
    "altstore://",
    "esign://",
    "gbox://",
    "gboxapp://",
    "ksign://",
    "kstore://"
  ];

  btn.addEventListener("click", async () => {
    for (const s of schemes) {
      try { window.location.href = s; } catch {}
      await new Promise(r => setTimeout(r, 450));
    }
  });
});
</script>

<!-- Старт авто-проверки -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const startBtn = document.getElementById("startFlowBtn");
  const text = document.getElementById("text");
  const reason = document.getElementById("reason");
  const enter = document.getElementById("enterBtn");

  enter.style.display = "none";

  startBtn.addEventListener("click", async () => {
    startBtn.disabled = true;
    startBtn.textContent = "Проверка…";
    text.textContent = "Идёт проверка устройства...";
    reason.textContent = "";

    try {
      const res = await window.startAutoFlow();

      if (res && res.allow === 1) {
        text.textContent = "Проверка пройдена";
        enter.style.display = "block";
        enter.disabled = false;
        startBtn.style.display = "none";
      } else {
        text.textContent = "Доступ запрещён";
        reason.textContent = res?.reason || "Сервер отклонил доступ.";
        startBtn.disabled = false;
        startBtn.textContent = "Начать проверку устройства";
      }

    } catch (e) {
      reason.textContent = "Ошибка";
      startBtn.disabled = false;
      startBtn.textContent = "Начать проверку устройства";
    }
  });
});
</script>

<!-- featureGate -->
<script>
(function() {
  async function testVT18() {
    const hasAPI = typeof document.startViewTransition === "function";
    const cssOK = typeof CSS?.supports === "function" && CSS.supports("view-transition-name: auto");
    let ran = false, finished = false;

    try {
      if (hasAPI) {
        const el = document.createElement("div");
        document.body.appendChild(el);
        const vt = document.startViewTransition(() => { ran = true; });
        await vt?.finished;
        finished = true;
        el.remove();
      }
    } catch {}

    return { pass: !!(hasAPI && cssOK && ran && finished) };
  }

  async function test184() {
    let shapeOK = false;
    try {
      const el = document.createElement("div");
      el.style.clipPath = "shape(from left, line to bottom)";
      shapeOK = !!el.style.clipPath;
    } catch {}
    const cookieOK = typeof cookieStore === "object";
    return { pass: !!(shapeOK && cookieOK) };
  }

  async function run() {
    const [vt, v184] = await Promise.all([testVT18(), test184()]);
    window.__featureGate = {
      overall: vt.pass,
      effective: { vt18Pass: vt.pass, v184Pass: v184.pass }
    };
  }

  document.addEventListener("DOMContentLoaded", run);
})();
</script>

<!-- fingerprint -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const API = window.__API_BASE;

  async function loadFP() {
    try {
      const resp = await fetch(API + "/api/gate", { method: "POST" });
      const j = await resp.json().catch(() => null);
      if (!j || !j.fingerprint?.short) return;

      const e = document.getElementById("fpId");
      e.querySelector("code").textContent = j.fingerprint.short;
      e.style.display = "block";
    } catch {}
  }

  setTimeout(loadFP, 150);
});
</script>

<script src="/app.js?v=21" defer></script>

</body>
</html>
