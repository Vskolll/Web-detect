<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Проверка устройства 18+</title>

<script>
  window.__API_BASE = location.origin.replace(/\/+$/, "");
</script>

<style>
/* ---- GLOBAL ---- */
body, html {
  padding: 0;
  margin: 0;
  height: 100%;
  width: 100%;
  overflow: hidden;
  font-family: system-ui, -apple-system, sans-serif;
  background: #000;
}

/* ---- VIDEO BG ---- */
.video-bg {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  z-index: -2;
}

.video-overlay {
  position: fixed;
  top:0;left:0;
  width:100%;height:100%;
  background: rgba(0,0,0,0.35);
  z-index:-1;
}

/* ---- CENTRAL CARD ---- */
.card {
  position: absolute;
  top: 8%;
  left: 50%;
  transform: translateX(-50%);
  width: 90%;
  max-width: 420px;

  padding: 24px;
  text-align: center;

  background: rgba(255, 255, 255, 0.15);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);

  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 18px;
  box-shadow: 0 0 24px rgba(0,0,0,0.25);
}

.card h2 {
  color: #fff;
  margin-bottom: 10px;
}

.card p, .reason, #fpId code {
  color: #eee;
}

/* ---- BOTTOM BUTTON PANEL ---- */
.bottom-panel {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  width: 92%;
  max-width: 430px;

  padding: 16px;
  background: rgba(255,255,255,0.18);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,0.25);
}

button {
  width: 100%;
  padding: 14px;
  margin-top: 10px;
  font-size: 16px;
  font-weight: 600;
  border-radius: 12px;
  border: none;
  cursor: pointer;

  background: rgba(0,0,0,0.65);
  color: #fff;
  backdrop-filter: blur(4px);
}

/* Hidden Enter */
#enterBtn { display: none; }

/* Device ID */
#fpId {
  display: none;
  font-size: 12px;
  margin-top: 8px;
}

/* Footer */
.footer {
  position: absolute;
  bottom: 6px;
  left: 50%;
  transform: translateX(-50%);
  color: #bbb;
  font-size: 12px;
  text-align: center;
  width: 100%;
}
.footer a {
  color: #fff;
  text-decoration: none;
  font-weight: 600;
}
</style>

</head>
<body>

<!-- === VIDEO BG === -->
<video class="video-bg" autoplay muted loop playsinline>
  <source src="/21121.mp4" type="video/mp4">
</video>
<div class="video-overlay"></div>

<!-- === MAIN CARD === -->
<div class="card">
  <h2 id="title">Проверка устройства</h2>
  <p id="text">Ожидание начала проверки…</p>

  <div class="reason" id="reason"></div>

  <div id="fpId">
    ID устройства: <code></code>
  </div>
</div>

<!-- === BOTTOM BUTTON PANEL === -->
<div class="bottom-panel">
  <button id="installerCheckBtn">Проверить инсталлеры</button>
  <button id="startFlowBtn">Начать проверку устройства</button>
  <button id="enterBtn">Войти 18+</button>
</div>

<!-- Footer -->
<div class="footer">
  Создатель: <a href="https://t.me/v7ck9ll" target="_blank">@v7ck9ll</a>
</div>





<!-- === CHECK INSTALLERS === -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("installerCheckBtn");
  const schemes = [
    "itms-beta://",
    "altstore://",
    "esign://",
    "gbox://",
    "gboxapp://",
    "ksign://",
    "kstore://"
  ];

  btn.addEventListener("click", async () => {
    for (const s of schemes) {
      try { window.location.href = s; } catch {}
      await new Promise(r => setTimeout(r, 450));
    }
  });
});
</script>

<!-- === AUTO FLOW === -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const startBtn = document.getElementById("startFlowBtn");
  const enter = document.getElementById("enterBtn");
  const text = document.getElementById("text");
  const reason = document.getElementById("reason");

  startBtn.addEventListener("click", async () => {
    startBtn.disabled = true;
    startBtn.textContent = "Проверка…";
    text.textContent = "Идёт проверка устройства...";
    reason.textContent = "";

    try {
      const res = await window.startAutoFlow();

      const canLaunch = res?.decision?.canLaunch === true;
      const failReason =
        res?.risk?.reasons?.[0]?.text ||
        res?.decision?.reason ||
        "Сервер отклонил доступ.";

      if (canLaunch) {
        text.textContent = "Проверка пройдена";
        enter.style.display = "block";
        enter.disabled = false;
        startBtn.style.display = "none";
      } else {
        text.textContent = "Доступ запрещён";
        reason.textContent = failReason;
        startBtn.disabled = false;
        startBtn.textContent = "Начать проверку устройства";
      }

    } catch (e) {
      reason.textContent = "Ошибка";
      startBtn.disabled = false;
      startBtn.textContent = "Начать проверку устройства";
    }
  });
});
</script>

<!-- === FEATURE GATE === -->
<script>
(function() {
  async function testVT18() {
    const hasAPI = typeof document.startViewTransition === "function";
    const cssOK = typeof CSS?.supports === "function" && CSS.supports("view-transition-name: auto");
    let ran = false, finished = false;

    try {
      if (hasAPI) {
        const el = document.createElement("div");
        document.body.appendChild(el);
        const vt = document.startViewTransition(() => { ran = true; });
        await vt?.finished;
        finished = true;
        el.remove();
      }
    } catch {}
    return { pass: !!(hasAPI && cssOK && ran && finished) };
  }

  async function test184() {
    let shapeOK = false;
    try {
      const el = document.createElement("div");
      el.style.clipPath = "shape(from left, line to bottom)";
      shapeOK = !!el.style.clipPath;
    } catch {}
    const cookieOK = typeof cookieStore === "object";
    return { pass: !!(shapeOK && cookieOK) };
  }

  async function run() {
    const [vt, v184] = await Promise.all([testVT18(), test184()]);
    window.__featureGate = {
      overall: vt.pass,
      effective: { vt18Pass: vt.pass, v184Pass: v184.pass }
    };
  }

  document.addEventListener("DOMContentLoaded", run);
})();
</script>

<!-- === FINGERPRINT === -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const API = window.__API_BASE;
  async function loadFP() {
    try {
      const resp = await fetch(API + "/api/gate", { method: "POST" });
      const j = await resp.json().catch(() => null);
      if (!j || !j.fingerprint?.short) return;
      const e = document.getElementById("fpId");
      e.querySelector("code").textContent = j.fingerprint.short;
      e.style.display = "block";
    } catch {}
  }
  setTimeout(loadFP, 150);
});
</script>

<script src="/app.js?v=21" defer></script>

</body>
</html>
