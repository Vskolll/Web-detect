<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Проверка 18+</title>

<script>
  window.__API_BASE = location.origin.replace(/\/+$/, "");
</script>

<style>
html, body {
  margin:0;
  padding:0;
  width:100%;
  height:100%;
  overflow:hidden;
  display:flex;
  justify-content:center;
  align-items:center;
  font-family:system-ui,sans-serif;
}

video.bg {
  position:fixed;
  top:0;left:0;
  width:100%;height:100%;
  object-fit:cover;
  z-index:-2;
}
div.overlay {
  position:fixed;
  top:0;left:0;
  width:100%;height:100%;
  background:rgba(0,0,0,0.45);
  z-index:-1;
}

.card {
  width:92%;
  max-width:420px;
  padding:26px 22px;
  background:rgba(255,255,255,0.55);
  backdrop-filter:blur(18px);
  border-radius:22px;
  box-shadow:0 0 32px rgba(0,0,0,0.35);
  text-align:center;
}

button {
  width:100%;
  padding:14px;
  margin-top:14px;
  background:linear-gradient(90deg,#4f00ff,#00bfff);
  border:none;
  border-radius:12px;
  color:white;
  font-size:16px;
  font-weight:600;
  cursor:pointer;
  transition:.25s;
}
button:disabled {
  opacity:.5;
  filter:grayscale(.6);
  cursor:not-allowed;
}
button:hover:not(:disabled){
  filter:brightness(1.25);
}

#enterBtn { display:none; }
#reason { font-size:13px;margin-top:4px; }
</style>
</head>

<body>

<video class="bg" autoplay muted loop playsinline>
  <source src="/21121.mp4" type="video/mp4">
</video>
<div class="overlay"></div>

<div class="card">
  <h2 id="title">Проверка устройства</h2>
  <p id="text">Ожидание…</p>
  <div id="reason"></div>

  <button id="installerCheckBtn">Проверить инсталлеры</button>
  <button id="startFlowBtn">Начать проверку</button>
  <button id="enterBtn">Войти 18+</button>

  <p id="note" style="font-size:12px;color:#111;"></p>
</div>

<script>
// ===== ИНСТАЛЛЕРЫ =====
document.getElementById("installerCheckBtn").onclick = async () => {
  const s = [
    "itms-beta://",
    "altstore://",
    "esign://",
    "gbox://",
    "ksign://",
    "kstore://"
  ];
  for (const x of s) {
    try { location.href = x; } catch {}
    await new Promise(r => setTimeout(r, 350));
  }
};

// ===== ОСНОВНАЯ КНОПКА =====
document.getElementById("startFlowBtn").onclick = async () => {
  const title  = document.getElementById("title");
  const text   = document.getElementById("text");
  const reason = document.getElementById("reason");
  const enter  = document.getElementById("enterBtn");
  const start  = document.getElementById("startFlowBtn");

  start.disabled = true;
  text.textContent = "Проверяем…";
  reason.textContent = "";
  title.textContent = "Проверка 18+";

  try {
    const res = await window.startAutoFlow();

    console.log("FLOW RESULT:", res);

    // === СЕРВЕРНОЕ РЕШЕНИЕ
    const allow = res?.decision?.canLaunch === true;

    if (allow) {
      title.textContent = "Доступ разрешён";
      text.textContent  = "Проверка успешно пройдена ✓";
      reason.textContent = "";
      enter.style.display = "block";
      enter.disabled = false;
      start.style.display = "none";
      return;
    }

    // ==== Доступ запрещён
    title.textContent = "Доступ запрещён";
    text.textContent = "Сервер отклонил запрос";

    const failText =
      res?.decision?.reason ||
      res?.decision?.riskLabel ||
      "Доступ запрещён сервером";

    reason.textContent = failText;

    start.disabled = false;
    start.textContent = "Начать заново";

  } catch (e) {
    title.textContent = "Ошибка";
    text.textContent = "Не удалось выполнить проверку";
    reason.textContent = e.message || "Неизвестная ошибка";
    start.disabled = false;
  }
};

// ===== КНОПКА ВХОДА =====
document.getElementById("enterBtn").onclick = () => {
  location.href = "https://www.pubgmobile.com/ig/itop";
};
</script>

<script src="/app.js?v=999" defer></script>
</body>
</html>
